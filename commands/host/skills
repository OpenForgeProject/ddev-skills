#!/usr/bin/env bash

## Description: Install or update required skills for MageForge
## Usage: skills
## Example: "ddev skills"

# Determine directory where this script is located
SCRIPT_DIR=$(dirname "$0")
CONFIG_FILE="${SCRIPT_DIR}/../../.env.skills"

# Load config
if [[ -f "${CONFIG_FILE}" ]]; then
    # Read skills from config file
    SKILLS_CONFIG=$(cat "${CONFIG_FILE}")
else
    echo "❌ Configuration file not found at ${CONFIG_FILE}"
    exit 1
fi

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${GREEN}OpenForge Skills Manager${NC}"
echo ""

# Check if skills are installed
INSTALLED_SKILLS=$(npx skills list 2>/dev/null || echo "")

# Process each line from config file
while IFS='=' read -r skill_name repo_url; do
    # Skip empty lines and comments
    [[ -z "$skill_name" || "$skill_name" =~ ^[[:space:]]*# ]] && continue

    # Remove quotes and whitespace
    skill_name=$(echo "$skill_name" | tr -d '"' | xargs)
    repo_url=$(echo "$repo_url" | tr -d '"' | xargs)

    if echo "$INSTALLED_SKILLS" | grep -q "$skill_name"; then
        echo -ne "${YELLOW}Updating: $skill_name${NC} "
        output=$(npx skills update --skill "$skill_name" -y 2>&1 < /dev/null)
        if [[ $? -eq 0 ]]; then
            echo -e "${GREEN}✓${NC}"
        else
            echo -e "${RED}✗${NC}"
        fi
    else
        echo -ne "${BLUE}Installing: $skill_name${NC} "
        output=$(npx skills add "$repo_url" --skill "$skill_name" -y 2>&1 < /dev/null)
        if echo "$output" | grep -q "Done!"; then
            echo -e "${GREEN}✓${NC}"
        else
            echo -e "${RED}✗${NC}"
        fi
    fi
done <<< "$SKILLS_CONFIG"

echo -e "${GREEN}✓ All skills are up to date!${NC}"

